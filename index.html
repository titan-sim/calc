<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dino Mutant 시뮬레이터 Pro (치명 로직 최적화)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 15px; background-color: #f4f4f9; color: #333; max-width: 800px; margin: 0 auto; line-height: 1.5; }
        .warning { font-size: 11px; color: #888; text-align: center; margin-bottom: 10px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; color: #666; }
        
        .slot-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; }
        .slot { aspect-ratio: 1; border: 2px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #fafafa; cursor: pointer; overflow: hidden; position: relative; }
        .slot img { width: 100%; height: 100%; object-fit: cover; }
        
        #runePicker { border-top: 2px solid #eee; padding-top: 20px; display: none; }
        .rune-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; max-height: 350px; overflow-y: auto; padding: 5px; }
        .rune-item { cursor: pointer; text-align: center; border: 2px solid transparent; padding: 5px; border-radius: 8px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .rune-item img { width: 50px; height: 50px; border-radius: 6px; background: #eee; }
        .rune-item span { font-size: 10px; display: block; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .detail-card { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .rune-grade { font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .grade-일반 { background: #A8D4FF; color: #314A86; }
        .grade-희귀 { background: #A8FFCB; color: #4C8149; }
        .grade-에픽 { background: #FBFFD3; color: #C1A62B; }
        .grade-유니크 { background: #FFD4A8; color: #E7641E; }
        .grade-전설 { background: #FFA8A8; color: #E33740; border: 1px solid #fbc02d; }
        
        .result-box { background: white; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #bbdefb; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-weight: bold; margin-top: 10px; }
        .pass { background: #e8f5e9; color: #2e7d32; }
        .fail { background: #ffebee; color: #c62828; }
        
        .btn-apply { background: #2196F3; color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-remove { background: #f44336; color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; }
        
        .accum-dmg-box { margin-bottom: 10px; padding: 8px; background: #fcfcfc; border: 1px dashed #ddd; border-radius: 6px; }
        .small-select { width: auto !important; padding: 4px 8px !important; font-size: 12px !important; height: auto !important; }
    </style>
</head>
<body>

<div class="warning">※ 본 시뮬레이터는 참고용이며, 게임 내 실제 연산 방식과 차이가 있을 수 있습니다.</div>

<div class="card">
    <div class="input-grid">
        <div><label>공룡 공격력</label><input type="number" id="baseAtk" value="1" onfocus="this.select()" oninput="autoCalc()"></div>
        <div><label>공룡 체력</label><input type="number" id="baseHp" value="10" onfocus="this.select()" oninput="autoCalc()"></div>
        <div style="grid-column: span 2;">
            <label>내 공룡 수</label>
            <select id="dinoCount" onchange="autoCalc()">
                <script>for(let i=1;i<=9;i++) document.write(`<option value="${i}">${i}마리</option>`);</script>
            </select>
        </div>
    </div>
</div>

<div class="card">
    <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #444; text-align: center;">
        룬을 장착할 슬롯을 선택하세요
    </div>
    <div class="slot-container">
        <script>for(let i=0;i<5;i++) document.write(`<div class="slot" id="slot${i}" onclick="openPicker(${i})"><small style="color:#ccc">슬롯 ${i+1}</small></div>`);</script>
    </div>
    <div id="runePicker">
        <div class="rune-grid" id="runeGrid"></div>
        <div id="detailArea" class="detail-card" style="display:none;">
            <div id="runeGrade" class="rune-grade">등급</div>
            <div style="margin-bottom:10px;"><label>레벨 (1~31)</label><select id="runeLevel" onchange="updateDetail()"></select></div>
            <div id="runeDesc" style="font-size:13px; color:#444; margin: 10px 0; white-space: pre-line; background:#fff; padding:10px; border-radius:4px; border:1px solid #eee;"></div>
            <button class="btn-apply" onclick="applyToSlot()">장착</button>
            <button id="removeBtn" class="btn-remove" onclick="removeRune()">해제</button>
        </div>
    </div>
</div>

<div class="card" style="margin-bottom: 10px;">
    <label>타이탄 레벨 선택</label>
    <select id="targetTitan" onchange="autoCalc()"></select>
</div>

<div class="card">
    <div id="finalStats" class="result-box">
        데이터를 입력해 주세요.
    </div>
</div>

<script>
    const TITAN_DATA = (function() {
        let data = [];
        let currentAtk = 5;
        let currentHp = 2500000;
        for (let lv = 1; lv <= 40; lv++) {
            data.push([lv, currentAtk, currentHp]);
            if (lv < 6) currentAtk += 5;
            else currentAtk += 15;
            if (lv < 4) currentHp += 2500000;
            else if (lv === 4) currentHp += 3125000;
            else currentHp += 3750000;
        }
        return data;
    })();

    const RUNES_DATA = {
        "힐": { grade: "일반", imgId: "10kOU5_hHneBmIpMJ-Hx0FuN-UanR5FDN", desc: "공격당할 때 {prob}% 확률로 최대 체력의 {value}% 회복", levels: (function(){ let lv={}; const data=[[5,1.0],[5,1.1],[5,1.2],[5,1.3],[5,1.4],[5,2.0],[5,2.1],[5,2.2],[5,2.3],[5,2.4],[8,2.5],[8,2.6],[8,2.7],[8,2.8],[8,2.9],[8,3.5],[8,3.6],[8,3.7],[8,3.8],[8,3.9],[10,4.0],[10,4.1],[10,4.2],[10,4.3],[10,4.4],[10,5.0],[10,5.1],[10,5.2],[10,5.3],[10,5.4],[13,8.0]]; data.forEach((d,i)=>lv[i+1]={prob:d[0], value:d[1]}); return lv; })() },
        "공격력 증가 1": { grade: "일반", imgId: "1ihowBMqeNvWag_4ou2JLgYilpLGvgnPa", desc: "공격력 {value} 증가", levels: (function(){ let lv={}; for(let i=1;i<=31;i++) lv[i]={value:i}; return lv; })() },
        "체력 증가 1": { grade: "일반", imgId: "1vNpdtLIozfnNOhjl2-gIMFH33xLmgh3P", desc: "체력 {value} 증가", levels: (function(){ let lv={}; for(let i=1;i<=31;i++) lv[i]={value:i*25}; return lv; })() },
        "트리플 임팩트": { grade: "일반", imgId: "1nO4CtfdB_FH7ZvCmL3uj1QPLDJte5mLB", desc: "3타마다 공격력의 {value}% 추가 피해", levels: (function(){ let lv={}; const v=[2,2.5,3,3.5,4,6,6.5,7,7.5,8,10,10.5,11,11.5,12,14,14.5,15,15.5,16,18,18.5,19,19.5,20,22,22.5,23,23.5,24,27]; v.forEach((val,i)=>lv[i+1]={value:val}); return lv; })() },
        "단단한 피부 1": { grade: "일반", imgId: "1oHu7Ep7BwL7Es4dBRVdTyfnSrfd_xIq1", desc: "피격 피해 {value} 감소", levels: (function(){ let lv={}; for(let i=1;i<=31;i++) lv[i]={value:i*2}; return lv; })() },
        "피해 저항 1": { grade: "일반", imgId: "1tBCAdO-UyCTP32gHwEc7TVISeRINsrqa", desc: "피격 시 {prob}% 확률로 피해 {value} 감소", levels: (function(){ let lv={}; const p=[30,30,30,30,30,35,35,35,35,35,35,35,35,35,35,40,40,40,40,40,40,40,40,40,40,45,45,45,45,45,50]; const v=[30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90]; p.forEach((pr,i)=>lv[i+1]={prob:pr, value:v[i]}); return lv; })() },
        "공격력 증가 2": { grade: "희귀", imgId: "1PKky7_H1ZXJNxzZJhByTw7hUclQ0aTRG", desc: "공격력 {value} 증가", levels: (function(){ let lv={}; for(let i=1;i<=31;i++) lv[i]={value:14+i}; return lv; })() },
        "체력 증가 2": { grade: "희귀", imgId: "1oIkxrSL3mVZo-fHXOv2Ot2Zmmftwpp3H", desc: "체력 {value} 증가", levels: (function(){ let lv={}; for(let i=1;i<=31;i++) lv[i]={value:350+(i*25)}; return lv; })() },
        "협동 공격": { grade: "희귀", imgId: "1DzFWPRILgHZAF28JrzUzKZQWKCtAN2vR", desc: "5인 이상일 때 공격력 {atk} 체력 {hp} 증가", levels: (function(){ let lv={}; const as=[35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,62,64,66,68,75]; const hs=[875,900,925,950,975,1000,1025,1050,1100,1125,1150,1175,1200,1225,1250,1275,1300,1325,1350,1375,1400,1425,1450,1475,1500,1550,1600,1650,1700,1875]; as.forEach((a,i)=>lv[i+1]={atk:a, hp:hs[i]}); return lv; })() },
        "고독한 분노": { grade: "희귀", imgId: "1hAyyAwatFwvlKqth4sunU_gURWoTY4ZJ", desc: "아군 1명일 때 공격력 {atk} 체력 {hp} 증가", levels: (function(){ let lv={}; for(let i=1;i<=31;i++) lv[i]={atk:14+i, hp:350+(i*25)}; return lv; })() },
        "단단한 피부 2": { grade: "희귀", imgId: "1XfdIrPSz_xm9v1KHB-TArpaRdv47zHLF", desc: "피격 피해 {value} 감소", levels: (function(){ let lv={}; for(let i=1;i<=31;i++) lv[i]={value:30 + (i*2)}; return lv; })() },
        "피해 저항 2": { grade: "희귀", imgId: "13As5kbKRnyJA81fUClKxILhq8P9Rws0c", desc: "피격 시 {prob}% 확률로 피해 {value} 감소", levels: (function(){ let lv={}; const p=[30,30,30,30,30,35,35,35,35,35,35,35,35,35,35,40,40,40,40,40,40,40,40,40,40,45,45,45,45,45,50]; const v=[70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,124,128,132,136,150]; p.forEach((pr,i)=>lv[i+1]={prob:pr, value:v[i]}); return lv; })() },
        "치명타 확률": { grade: "에픽", imgId: "1rZUa6JfGfbksXt1qOO32veoEty9er_Bu", desc: "치명타 확률 {value}% 증가", levels: (function(){ let lv={}; const v=[13,13.3,13.6,13.9,14.2,17,17.3,17.6,17.9,18.2,21,21.3,21.6,21.9,22.2,25,25.5,26,26.5,27,30,30.5,31,31.5,32,35,35.5,36,36.5,37,40]; v.forEach((val,i)=>lv[i+1]={value:val}); return lv; })() },
        "치명타 피해": { grade: "에픽", imgId: "127l8ExJLlQENOySkwk_TiNDLO5gKo7Rm", desc: "치명타 피해 {value}% 증가", levels: (function(){ let lv={}; const v=[20,20.5,21,21.5,22,25,25.5,26,26.5,27,30,30.5,31,31.5,32,35,36,37,38,39,42,43,44,45,46,50,51,52,53,54,60]; v.forEach((val,i)=>lv[i+1]={value:val}); return lv; })() },
        "공격력 증가 3": { grade: "에픽", imgId: "1MBbzM8Snw4awmVoS-mBe1ATN_WlkcwqL", desc: "공격력 {value} 증가", levels: (function(){ let lv={}; const v=[35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,62,64,66,68,75]; v.forEach((val,i)=>lv[i+1]={value:val}); return lv; })() },
        "체력 증가 3": { grade: "에픽", imgId: "1r_tPl7V2ydsAD3p_amPfL1d92i-6AFLN", desc: "체력 {value} 증가", levels: (function(){ let lv={}; const v=[875,900,925,950,975,1000,1025,1050,1075,1100,1125,1150,1175,1200,1225,1250,1275,1300,1325,1350,1375,1400,1425,1450,1475,1500,1550,1600,1650,1700,1875]; v.forEach((val,i)=>lv[i+1]={value:val}); return lv; })() },
        "압축된 힘": { grade: "에픽", imgId: "1aaijjlcR-GjrDeZy4WzBqFN2J7oBiw2C", desc: "공격력 {atk}% 증가 / 체력 25% 감소", levels: (function(){ let lv={}; const atks=[15,15.2,15.4,15.6,15.8,17,17.5,18,18.5,19,22,22.5,23,23.5,24,27,27.5,28,28.5,29,33,33.5,34,34.5,35,39,39.5,40,40.5,41,45]; atks.forEach((a,i)=>lv[i+1]={atk:a}); return lv; })() },
        "매머드의 힘": { grade: "에픽", imgId: "14UVrJVEIr5xZghRiG96doS_QhOQ0VxBK", desc: "체력 {hp}% 증가 / 공격력 25% 감소", levels: (function(){ let lv={}; const hps=[19.5,20,20.5,21,21.5,27,27.5,28,28.5,29,34.5,35.5,36.5,37.5,38.5,44.5,45.8,47,48.3,49.5,59.5,60.8,62,63.3,64.5,79.5,80.8,82,83.3,84.5,102]; hps.forEach((h,i)=>lv[i+1]={hp:h}); return lv; })() },
        "흡혈": { grade: "유니크", imgId: "1wpM4jrjnyShM9jkrWQuleCMRQzqajRg-", desc: "공격 시 {prob}% 확률로 공격력의 {value}% 체력 회복", levels: (function(){ let lv={}; const p=[15,15,15,15,15,15,15,15,15,15,20,20,20,20,20,20,20,20,20,20,25,25,25,25,25,25,25,25,25,25,30]; const v=[30,32,34,36,38,45,47,49,51,53,55,57,59,61,63,70,72,74,76,78,80,82,84,86,88,95,97,99,101,103,110]; p.forEach((prob,i)=>lv[i+1]={prob:prob, value:v[i]}); return lv; })() },
        "강타": { grade: "유니크", imgId: "1duFRCFWSfwJIT4FcOfDcJU5t9_sYYSNd", desc: "공격력 {value}% 증가", levels: (function(){ let lv={}; const v=[7,7.2,7.4,7.6,7.8,10,10.2,10.4,10.6,10.8,13,13.4,13.8,14.2,14.6,17,17.5,18,18.5,19,23,23.5,24,24.5,25,31,31.5,32,32.5,33,40]; v.forEach((val,i)=>lv[i+1]={value:val}); return lv; })() },
        "방어벽": { grade: "유니크", imgId: "19nNX-o2m8lDQfKLe5YXd7JijVf7HK0iI", desc: "체력 {value}% 증가", levels: (function(){ let lv={}; const v=[17.5,18,18.5,19,19.5,25,25.5,26,26.5,27,32.5,33.5,34.5,35.5,36.5,42.5,43.8,45,46.3,47.5,57.5,58.8,60,61.3,62.5,77.5,78.8,80,81.3,82.5,100]; v.forEach((val,i)=>lv[i+1]={value:val}); return lv; })() },
        "메테오": { grade: "전설", imgId: "1fJVyoKiTVH1i0votjXaXuwAbTZjxnM-P", desc: "공격 시 {prob}% 확률 광역 {value}% 추가 피해\n[패시브] 공/체 {extra}% 증가", levels: (function(){ let lv={}; const p=[50,50,50,50,50,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,60,60,60,60,60,65,65,65,65,65,65]; const d=[15,16,17,18,19,20,21,22,23,24,40,41,42,43,44,50,51,52,53,54,65,66,67,68,69,70,71,72,73,74,80]; const e=[2,2,2,2,2,2,2,2,2,2,4,4,4,4,4,4,4,4,4,4,7,7,7,7,7,7,7,7,7,7,10]; p.forEach((prob,i)=>lv[i+1]={prob:prob, value:d[i], extra:e[i]}); return lv; })() },
        "낙뢰": { grade: "전설", imgId: "1pPUwyTblvZJDbTAPUOJYr8hdUqPTZmy4", desc: "공격 시 {prob}% 확률 단일 {value}% 추가 피해\n[패시브] 공/체 {extra}% 증가", levels: (function(){ let lv={}; const p=[40,40,40,40,40,45,45,45,45,45,50,50,50,50,50,50,50,50,50,50,60,60,60,60,60,65,65,65,65,65,65]; const d=[40,40.5,41,41.5,42,50,50.5,51,51.5,52,67.5,68,68.5,69,69.5,82.5,83,83.5,84,84.5,90,90.5,91,91.5,92,100,100.5,101,101.5,102,115]; const e=[2,2,2,2,2,2,2,2,2,2,4,4,4,4,4,4,4,4,4,4,7,7,7,7,7,7,7,7,7,7,10]; p.forEach((prob,i)=>lv[i+1]={prob:prob, value:d[i], extra:e[i]}); return lv; })() }
    };

    let state = { slots: [null,null,null,null,null], activeIdx: null, tempRune: null, selectedAccumTime: 10 };
    
    const titanSel = document.getElementById('targetTitan');
    TITAN_DATA.forEach(t => titanSel.add(new Option(`Lv.${t[0]} (ATK ${t[1]} / HP ${t[2].toLocaleString()})`, t[0])));

    const lvSelect = document.getElementById('runeLevel');
    for(let i=1; i<=31; i++) lvSelect.add(new Option(i + "Lv", i));

    const grid = document.getElementById('runeGrid');
    for (let name in RUNES_DATA) {
        const item = document.createElement('div');
        item.className = 'rune-item';
        item.innerHTML = `<img src="https://drive.google.com/thumbnail?id=${RUNES_DATA[name].imgId}&sz=200"><span>${name}</span>`;
        item.onclick = () => selectRuneFromGrid(name, item);
        grid.appendChild(item);
    }

    function openPicker(idx) {
        state.activeIdx = idx;
        document.getElementById('runePicker').style.display = 'block';
        if(state.slots[idx]) {
            document.getElementById('removeBtn').style.display = 'block';
            selectRuneFromGrid(state.slots[idx].name);
            document.getElementById('runeLevel').value = state.slots[idx].level;
        } else { 
            document.getElementById('removeBtn').style.display = 'none'; 
            document.getElementById('detailArea').style.display = 'none';
        }
    }

    function selectRuneFromGrid(name, el) {
        state.tempRune = name;
        document.querySelectorAll('.rune-item').forEach(i => i.style.borderColor = 'transparent');
        if(el) el.style.borderColor = '#2196F3';
        document.getElementById('detailArea').style.display = 'block';
        updateDetail();
    }

    function updateDetail() {
        if (!state.tempRune) return;
        const lv = document.getElementById('runeLevel').value;
        const data = RUNES_DATA[state.tempRune];
        const gradeEl = document.getElementById('runeGrade');
        gradeEl.innerText = `${data.grade} 등급`;
        gradeEl.className = `rune-grade grade-${data.grade}`;
        let d = data.desc;
        const eff = data.levels[lv];
        for (let k in eff) d = d.split(`{${k}}`).join(eff[k]);
        document.getElementById('runeDesc').innerText = d;
    }

    function applyToSlot() {
        const idx = state.activeIdx;
        const lv = document.getElementById('runeLevel').value;
        const runeName = state.tempRune;
        state.slots.forEach((s, i) => {
            if (s && s.name === runeName && i !== idx) {
                state.slots[i] = null;
                document.getElementById(`slot${i}`).innerHTML = `<small style="color:#ccc">슬롯 ${i+1}</small>`;
            }
        });
        state.slots[idx] = { name: runeName, level: lv, effect: RUNES_DATA[runeName].levels[lv] };
        document.getElementById(`slot${idx}`).innerHTML = `<img src="https://drive.google.com/thumbnail?id=${RUNES_DATA[runeName].imgId}&sz=200">`;
        document.getElementById('runePicker').style.display = 'none';
        autoCalc();
    }

    function removeRune() {
        state.slots[state.activeIdx] = null;
        document.getElementById(`slot${state.activeIdx}`).innerHTML = `<small style="color:#ccc">슬롯 ${state.activeIdx+1}</small>`;
        document.getElementById('runePicker').style.display = 'none';
        autoCalc();
    }

    function formatTime(seconds) {
        if (seconds >= 999999) return "무한";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        let res = "";
        if (h > 0) res += h + "시간 ";
        if (m > 0 || h > 0) res += m + "분 ";
        res += s + "초";
        return res;
    }

    function autoCalc() {
        const bA = Number(document.getElementById('baseAtk').value) || 0;
        const bH = Number(document.getElementById('baseHp').value) || 0;
        const count = Number(document.getElementById('dinoCount').value);
        const titanLv = Number(document.getElementById('targetTitan').value);
        const titanInfo = TITAN_DATA.find(t => t[0] === titanLv);
        const dSpd = 0.75, tSpd = 2.4;
        
        // 초기화
        let cProb = 3, cDmg = 5; 
        let iA = 0, iH = 0, pA = 0, pH = 0;
        let extraProbs = []; // [{prob, rate}] 형태로 추가 피해 저장
        let hRate = 0, lsRate = 0, redFix = 0, redPct = 0;

        // 1. 룬 효과 수집
        state.slots.forEach(s => {
            if(!s) return;
            const e = s.effect, n = s.name;
            if(n.includes("공격력 증가") && !n.includes("%")) iA += Number(e.value);
            else if(n.includes("체력 증가") && !n.includes("%")) iH += Number(e.value);
            else if(n==="협동 공격" && count >= 5) { iA += Number(e.atk); iH += Number(e.hp); }
            else if(n==="고독한 분노" && count === 1) { iA += Number(e.atk); iH += Number(e.hp); }
            if(n==="강타") pA += parseFloat(e.value);
            if(n==="치명타 확률") cProb += parseFloat(e.value);
            if(n==="치명타 피해") cDmg += parseFloat(e.value);
            if(n==="방어벽") pH += parseFloat(e.value);
            if(n==="압축된 힘") { pA += parseFloat(e.atk); pH -= 25; }
            if(n==="매머드의 힘") { pH += parseFloat(e.hp); pA -= 25; }
            if(n.includes("단단한 피부")) redFix += Number(e.value);
            if(n==="피해 저항 1" || n==="피해 저항 2") redFix += (e.prob/100 * e.value);
            if(n==="메테오" || n==="낙뢰") { 
                pA += Number(e.extra); 
                pH += Number(e.extra); 
                extraProbs.push({prob: e.prob/100, rate: e.value/100}); 
            }
            if(n==="트리플 임팩트") extraProbs.push({prob: 1/3, rate: e.value/100}); 
            if(n==="힐") hRate += (e.prob/100 * e.value/100); 
            if(n==="흡혈") lsRate += (e.prob/100 * e.value/100); 
        });

        // 2. 최종 공격력 결정 (정수 합산 후 % 반영)
        const fA = (bA + iA) * (1 + pA/100);
        const fH = (bH + iH) * (1 + pH/100);

        // 3. 치명타 기댓값 계산 (1 + 확률 * 피해량)
        // 요청하신 대로 치명타는 제일 마지막에 각 데미지 소스에 개별 적용
        const critMultiplier = 1 + (cProb/100 * (cDmg/100));

        // 4. 회당 평균 데미지 계산
        // (직접 공격 * 치명배수) + (각 추가피해 * 치명배수)
        let avgDmgPerHit = fA * critMultiplier; 
        extraProbs.forEach(ex => {
            avgDmgPerHit += (fA * ex.rate * ex.prob) * critMultiplier;
        });

        // 5. DPS 및 생존 계산
        const dps = avgDmgPerHit / dSpd * count;
        const accumTimeSec = state.selectedAccumTime * 60;
        const totalAccumDmg = dps * accumTimeSec;
        const hpPercent = ((totalAccumDmg / titanInfo[2]) * 100).toFixed(2);

        const finalDamageTaken = Math.max(1, (titanInfo[1] * (1 - redPct/100)) - redFix);
        const netDamagePerHit = Math.max(0, finalDamageTaken - ((fH * hRate) + (fA * lsRate * (tSpd/dSpd))));
        const survivalTime = netDamagePerHit <= 0 ? 999999 : (fH / (netDamagePerHit / tSpd));
        const timeToKill = titanInfo[2] / dps;
        const isWin = survivalTime >= timeToKill;

        let options = '';
        for(let m=10; m<=120; m+=10) {
            options += `<option value="${m}" ${state.selectedAccumTime == m ? 'selected' : ''}>${m}분</option>`;
        }

        document.getElementById('finalStats').innerHTML = `
            <div style="font-size:13px; color:#666; margin-bottom:10px; border-bottom:1px solid #bbdefb; padding-bottom:10px;">
                최종 공격력: <b>${Math.floor(fA).toLocaleString()}</b> / 최종 체력: <b>${Math.floor(fH).toLocaleString()}</b><br>
                1회 피격 당 누적 피해: <b>${Math.floor(netDamagePerHit)}</b>
            </div>
            
            <div class="accum-dmg-box">
                <span style="font-size:12px; color:#555;">시간 설정: </span>
                <select class="small-select" onchange="state.selectedAccumTime = this.value; autoCalc();">
                    ${options}
                </select>
                <div style="font-size:13px; font-weight:bold; margin-top:5px; color:#1976d2;">
                    ${state.selectedAccumTime}분간 총 피해: ${Math.floor(totalAccumDmg).toLocaleString()}<br>
                    (전체 체력의${hpPercent}%)
                </div>
            </div>

            <div style="font-weight:bold; font-size:20px; color:#2e7d32; margin:5px 0;">DPS: ${Math.floor(dps).toLocaleString()}</div>
            <div style="font-size:13px;">킬타임: ${formatTime(timeToKill)} / 생존시간: ${formatTime(survivalTime)}</div>
            <div class="status-badge ${isWin?'pass':'fail'}">${isWin?'클리어 가능':'스펙 부족'}</div>
        `;
    }
    autoCalc();
</script>
</body>
</html>
